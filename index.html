<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Base64 Tetragram Decoder</title>
<style>
  body {
    font-family: monospace;
    padding: 20px;
  }
  textarea, input {
    width: 100%;
  }
  textarea {
    height: 120px;
  }
  .output {
    margin-top: 20px;
    white-space: pre-wrap;
    word-break: break-all;
    font-family: monospace;
  }
  .hit {
    background-color: #ffeb3b;
  }
</style>
</head>
<body>

<h2>Base64 Decode-and-Check Scanner</h2>
<p>
  <i>By Rebase</i><br><br>
  This tool highlights any Base64 tetragram whose decoded bytes all fall within
  a user-defined readable character set.
</p>

<p>Paste a Base64 string:</p>
<textarea id="input"></textarea>

<p>Allowed decoded characters (leave blank for default):</p>
<input id="charset" placeholder="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,?! ">

<br><br>
<button id="scan">Scan</button>

<div class="output" id="output"></div>

<script>
function reverseString(str) {
  let out = "";
  for (let i = str.length - 1; i >= 0; i--) {
    out += str[i];
  }
  return out;
}

// Default allowed characters
const DEFAULT_ALLOWED_CHARS =
  "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,?! ";

// Strict Base64 regex (no padding)
const B64_RE = /^[A-Za-z0-9+/]{4}$/;

function buildAllowedSet(chars) {
  return new Set([...chars].map(c => c.charCodeAt(0)));
}

function isValidTetragram(b64, allowedSet) {
  if (!B64_RE.test(b64)) return false;

  try {
    const bin = atob(b64);
    if (bin.length !== 3) return false;

    for (let i = 0; i < 3; i++) {
      if (!allowedSet.has(bin.charCodeAt(i))) {
        return false;
      }
    }
    return true;
  } catch {
    return false;
  }
}

document.getElementById("scan").addEventListener("click", () => {
  const s = document.getElementById("input").value.trim();
  const charsetInput = document.getElementById("charset").value;

  const allowedChars =
    charsetInput.length > 0 ? charsetInput : DEFAULT_ALLOWED_CHARS;

  const allowedSet = buildAllowedSet(allowedChars);
  const hits = new Array(s.length).fill(false);

  for (let i = 0; i <= s.length - 4; i++) {
    const quad = s.slice(i, i + 4);
    if (isValidTetragram(quad, allowedSet)) {
      for (let j = i; j < i + 4; j++) {
        hits[j] = true;
      }
    }
  }

  let out = "";
  for (let i = 0; i < s.length; i++) {
    out += hits[i]
      ? `<span class="hit">${s[i]}</span>`
      : s[i];
  }

  out += "\n\n<b>Reversed results:</b>\n";

  const reversedHits = new Array(s.length).fill(false);
  const reversed = reverseString(s);

  for (let i = 0; i <= reversed.length - 4; i++) {
    const quad = reversed.slice(i, i + 4);
    if (isValidTetragram(quad, allowedSet)) {
      for (let j = i; j < i + 4; j++) {
        reversedHits[j] = true;
      }
    }
  }


  for (let i = 0; i < reversed.length; i++) {
    out += reversedHits[i]
      ? `<span class="hit">${reversed[i]}</span>`
      : reversed[i];
  }

  document.getElementById("output").innerHTML = out;
});
</script>

</body>
</html>
