<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Encoded Text Scanner</title>
<style>
  body {
    font-family: monospace;
    padding: 20px;
  }
  textarea, input, select {
    width: 100%;
  }
  textarea {
    height: 120px;
  }
  .output {
    margin-top: 20px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .hit {
    background-color: #ffeb3b;
  }
</style>
</head>
<body>

<h2>Encoded Text Decode-and-Check Scanner</h2>
<p>
  <i>By Rebase</i><br><br>
  Highlights encoded substrings whose decoded bytes fall entirely within
  a custom readable character set. By default, the character set is set
  to <i>[A-Za-z0-9\s.,?!]</i>
</p>
<p>
    <ul>
        <li><b>Base 64:&nbsp;</b>slides across tetragrams and highlights matches.</li>
        <li><b>Hexadecimal:&nbsp;</b>Slides across bigrams and highlights matches.</li>
        <li><b>Octal:&nbsp;</b>Evaluates tokens and highlights matches.</li>
        <li><b>Decimal:&nbsp;</b>Evaluates tokens and highlights matches.</li>
    </ul>
</p>

<p>Input encoding:</p>
<select id="mode">
  <option value="base64">Base64</option>
  <option value="hex">Hex</option>
  <option value="octal">Octal</option>
  <option value="decimal">Decimal</option>
</select>

<p>Paste encoded text:</p>
<textarea id="input"></textarea>

<p>Allowed decoded characters (leave blank for default):</p>
<input id="charset" placeholder="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,?! ">

<br><br>
<button id="scan">Scan</button>

<div class="output" id="output"></div>

<script>
function reverseString(str) {
  return [...str].reverse().join("");
}

const DEFAULT_ALLOWED_CHARS =
  "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,?! ";

function buildAllowedSet(chars) {
  return new Set([...chars].map(c => c.charCodeAt(0)));
}

const B64_RE = /^[A-Za-z0-9+/]{4}$/;
const HEX_RE = /^[0-9a-fA-F]{2}$/;
const OCT_RE = /^[0-7]+$/;
const DEC_RE = /^[0-9]+$/;

function validByte(byte, allowedSet) {
  return allowedSet.has(byte);
}


function scanBase64(s, allowedSet) {
  const hits = new Array(s.length).fill(false);

  for (let i = 0; i <= s.length - 4; i++) {
    const quad = s.slice(i, i + 4);
    if (!B64_RE.test(quad)) continue;

    try {
      const bin = atob(quad);
      if (bin.length !== 3) continue;

      let ok = true;
      for (let j = 0; j < 3; j++) {
        if (!validByte(bin.charCodeAt(j), allowedSet)) {
          ok = false;
          break;
        }
      }

      if (ok) {
        for (let j = i; j < i + 4; j++) hits[j] = true;
      }
    } catch {}
  }
  return hits;
}


function scanHex(s, allowedSet) {
  const hits = new Array(s.length).fill(false);

  for (let i = 0; i <= s.length - 2; i++) {
    const pair = s.slice(i, i + 2);
    if (!HEX_RE.test(pair)) continue;

    try {
      const byte = parseInt(pair, 16);
      if (validByte(byte, allowedSet)) {
        hits[i] = hits[i + 1] = true;
      }
    } catch {}
  }
  return hits;
}


function scanNumericTokens(s, allowedSet, base) {
  const spans = [];
  const tokens = s.split(/\s+/);
  let offset = 0;

  for (const tok of tokens) {
    const start = s.indexOf(tok, offset);
    const end = start + tok.length;
    offset = end;

    let value;
    try {
      if (base === 8 && OCT_RE.test(tok)) {
        value = parseInt(tok, 8);
      } else if (base === 10 && DEC_RE.test(tok)) {
        value = parseInt(tok, 10);
      } else {
        continue;
      }

      if (value >= 0 && value <= 255 && validByte(value, allowedSet)) {
        spans.push([start, end]);
      }
    } catch {}
  }
  return spans;
}


function renderCharHits(s, hits) {
  let out = "";
  for (let i = 0; i < s.length; i++) {
    out += hits[i] ? `<span class="hit">${s[i]}</span>` : s[i];
  }
  return out;
}

function renderTokenHits(s, spans) {
  let out = s;
  for (let i = spans.length - 1; i >= 0; i--) {
    const [a, b] = spans[i];
    out =
      out.slice(0, a) +
      `<span class="hit">${out.slice(a, b)}</span>` +
      out.slice(b);
  }
  return out;
}


document.getElementById("scan").addEventListener("click", () => {
  const input = document.getElementById("input").value.trim();
  const mode = document.getElementById("mode").value;
  const charsetInput = document.getElementById("charset").value;
  const allowedChars = charsetInput || DEFAULT_ALLOWED_CHARS;
  const allowedSet = buildAllowedSet(allowedChars);

  let out = "";

  if (mode === "base64") {
    out += renderCharHits(input, scanBase64(input, allowedSet));

    out += "\n\n<b>Reversed results:</b>\n";
    const rev = reverseString(input);
    out += renderCharHits(rev, scanBase64(rev, allowedSet));

  } else if (mode === "hex") {
    out += renderCharHits(input, scanHex(input, allowedSet));

    out += "\n\n<b>Reversed results:</b>\n";
    const rev = reverseString(input);
    out += renderCharHits(rev, scanHex(rev, allowedSet));

  } else {
    const base = mode === "octal" ? 8 : 10;

    out += renderTokenHits(input, scanNumericTokens(input, allowedSet, base));

    out += "\n\n<b>Reversed results:</b>\n";
    const rev = reverseString(input);
    out += renderTokenHits(rev, scanNumericTokens(rev, allowedSet, base));
  }

  document.getElementById("output").innerHTML = out;
});
</script>

</body>
</html>
